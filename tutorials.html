<!doctype html>
<html lang="en">
<head>
	<!-- for IE HTML5 compatibility -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta charset="UTF-8">
	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
	<link rel="icon" href="favicon.ico" type="image/x-icon">

	<title>LuaAV: tutorials</title>
	<link rel="stylesheet" href="css/main.css" type="text/css" />
	
	<!--[if IE]>
		<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<!--[if lt IE 9]>
		<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
	<![endif]-->
	<!--[if lte IE 6]>
		<link rel="stylesheet" href="http://universal-ie6-css.googlecode.com/files/ie6.1.1.css" media="screen, projection">
	<![endif]-->
	
	<!--
	<link rel="stylesheet" href="css/lightbox.css" type="text/css" media="screen" />
	<script src="js/lightbox.js" type="text/javascript"></script>
	<script src="js/jquery.js" type="text/javascript"></script>
	-->
</head>

<body>
<nav>
	<table border="0">
		<tr valign="bottom">
			<td><img src="img/logo.png" border="0" /></td>	
			<td>
				<ul>
					<li><a href="index.html">LuaAV</a></li>
					<li><a href="download.html">Download/Source</a></li>
					<li><a href="tutorials.html">Tutorials</a></li>
					<li><a href="doc/index.html">Reference</a></li>
					<li><a href="http://sonic.mat.ucsb.edu/mailman/listinfo/lua-av">Mailing List</a></li>
				</ul>
			</td>
		</tr>
	</table>
</nav>	

<!-- side
<div id="side">

	<p><a href="endless_current.html" title="Endless Current">
	<img src="img/endless1_192_108.jpg" alt="Endless Current" />
	Endless Current</a></p>

	<p><a href="archipelago.html" title="Archipelago">
	<img src="img/archipelago1_192_108.jpg" alt="Archipelago" />
	Archipelago</a></p>

	<p><a href="chronoforms.html" title="Chronophotography">
	<img src="img/chrono_render_192_108.jpg" alt="Chronophotography Study" />
	Chronophotography</a></p>

	<p><a href="flux.html" title="Flux">
	<img src="img/flux_allosphere_192.jpg" alt="Flux" />
	Flux</a></p>

	<p><a href="city_life.html" title="City Life">
	<img src="img/city_life_192.jpg" alt="City Life" />
	City Life</a></p>

	<p><a href="time_of_doubles.html" title="Time of Doubles">
	<img src="img/tod_soma_192.jpg" alt="TYPE:WALL, SOMA Museum 2011" />
	Time of Doubles</a></p>

	<p><a href="fluid_space.html" title="Fluid Space">
	<img src="img/translab2_192.jpg" width="192" height="108" alt="Fluid Space @TransLAB" />
	Fluid Space</a></p>

	<p><a href="infinite_game.html" title="Infinite Game">
	<img src="img/tmca1_192.jpg" alt="Infinite Game @Total Museum of Contemporary Art" />
	Infinite Game</a></p>

</div>  -->

<div id="main"><!-- @main -->
<h1>Tutorials</h1>

<h1>Lua 5.1 / LuaJIT Quick Tutorial</h1>

<p>Commonly compared to: JavaScript, Ruby, Python, Scheme. Notable characteristics:</p>

<ul>
<li>Fast (used widely for game engines). <a href="www.luajit.org">LuaJIT</a> can approach and sometimes exceed C. </li>
<li>Clean &amp; powerful array/dictionary data structure (table)</li>
<li>Proper lexical scoping</li>
<li>First-class functions</li>
<li>Coroutines </li>
<li>Garbage collected</li>
<li>Prototype inheritance (similar to <a href="http://en.wikipedia.org/wiki/Self_%28programming_language">Self</a>)</li>
<li>Small, portable &amp; easy to embed with C</li>
<li><a href="http://www.opensource.org/licenses/mit-license.php">MIT license</a></li>
</ul>


<h2>Syntax</h2>

<pre><span class="comment">-- Two dashes create a comment that ends at the line break</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"hello world"</span><span class="symbol">)</span>
<span class="comment">-- Note: no need for semicolons to terminate statements.</span>
</pre>


<h3>Simple types</h3>

<pre><span class="comment">-- Unlike C, the type information is stored with the value, not the variable; </span>
<span class="comment">-- this means that the type of a variable can change dynamically.</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">1</span>           <span class="comment">-- x now refers to a number</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="string">"foo"</span>       <span class="comment">-- x now refers to a string</span>

<span class="comment">-- check types like this:</span>
<span class="keyword">if</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-type"><span class="global">type</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span> <span class="symbol">==</span> <span class="string">"number"</span> <span class="keyword">then</span> 
    <span class="comment">-- do stuff</span>
<span class="keyword">end</span>

<span class="comment">-- these lines are all equivalent</span>
<span class="comment">-- they assign the number value 1 to the variable name x:</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">1</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">1.0</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">100e-2</span>  <span class="comment">-- e base10 format</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">0x1</span> <span class="comment">--hexadecimal format</span>
<span class="comment">-- Note: all numbers in Lua are 64-bit doubles</span>

<span class="comment">-- strings:</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"a simple string"</span><span class="symbol">)</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">'a simple string'</span><span class="symbol">)</span>

<span class="comment">-- embedding special characters and multi-line strings:</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="string">'escape the \' character, and write \n a new line'</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="string">[[
The double square brackets are a simple way to write strings
that span
over several
lines]]</span>

<span class="comment">-- Boolean values:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="keyword">true</span>
<span class="identifier">f</span> <span class="symbol">=</span> <span class="keyword">false</span>
<span class="keyword">if</span> <span class="identifier">t</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"t!"</span><span class="symbol">)</span> <span class="keyword">end</span> <span class="comment">-- prints t!</span>
<span class="keyword">if</span> <span class="identifier">f</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"f!"</span><span class="symbol">)</span> <span class="keyword">end</span> <span class="comment">-- prints nothing</span>

<span class="comment">-- nil indicates the absence of value. </span>
<span class="comment">-- Assigning nil to a variable marks the variable for garbage collection.</span>
<span class="identifier">n</span> <span class="symbol">=</span> <span class="keyword">nil</span>
<span class="comment">-- nil also evaluates to false for a predicate:</span>
<span class="keyword">if</span> <span class="identifier">n</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"n!"</span><span class="symbol">)</span> <span class="keyword">end</span> <span class="comment">-- prints nothing</span>
</pre>


<h3>Structured data</h3>

<p>Lua provides only one data structure: the <em>table</em>. Tables in Lua are associative arrays, mapping <strong>keys</strong> to <strong>values</strong>. Both keys and values can be <em>any</em> valid Lua type except nil. However, the implementation makes sure that when used with continuous number keys, the table performs as a fast array. </p>

<pre><span class="comment">-- creating an array-like table of strings, the quick way:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span> <span class="symbol">}</span>

<span class="comment">-- creating a dictionary-like table, the quick way:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="identifier">one</span> <span class="symbol">=</span> <span class="number">1</span>, <span class="identifier">two</span> <span class="symbol">=</span> <span class="number">2</span>, <span class="identifier">three</span> <span class="symbol">=</span> <span class="number">3</span> <span class="symbol">}</span>

<span class="comment">-- creating a table with both array-like and dictionary-like parts:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>, <span class="identifier">one</span> <span class="symbol">=</span> <span class="number">1</span>, <span class="identifier">two</span> <span class="symbol">=</span> <span class="number">2</span>, <span class="identifier">three</span> <span class="symbol">=</span> <span class="number">3</span> <span class="symbol">}</span>

<span class="comment">-- create an empty table:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="symbol">{</span><span class="symbol">}</span>

<span class="comment">-- add or replace key-value pairs in the table:</span>
<span class="identifier">t</span>[<span class="number">1</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="string">"one"</span>    <span class="comment">-- array-like</span>
<span class="identifier">t</span>[<span class="string">"two"</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="number">2</span>    <span class="comment">-- dictionary-like</span>
<span class="comment">-- a simpler way of saying that:</span>
<span class="identifier">t</span><span class="symbol">.</span><span class="identifier">two</span> <span class="symbol">=</span> <span class="number">2</span>

<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">t</span><span class="symbol">.</span><span class="identifier">two</span>, <span class="identifier">t</span>[<span class="string">"two"</span><span class="symbol">]</span><span class="symbol">)</span>    <span class="comment">--> 2 2</span>

<span class="comment">-- remove a key-value pair by assigning the value nil:</span>
<span class="identifier">t</span><span class="symbol">.</span><span class="identifier">two</span> <span class="symbol">=</span> <span class="keyword">nil</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">t</span><span class="symbol">.</span><span class="identifier">two</span><span class="symbol">)</span>          <span class="comment">--> <nil></span>

<span class="comment">-- create a table with a sub-table:</span>
<span class="identifier">t</span> <span class="symbol">=</span> <span class="symbol">{</span>
    <span class="identifier">numbers</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> <span class="symbol">}</span>,
    <span class="identifier">letters</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="string">"a"</span>, <span class="string">"b"</span>, <span class="string">"c"</span> <span class="symbol">}</span>,
<span class="symbol">}</span>

<span class="comment">-- any Lua type (except nil) can be used as key or value</span>
<span class="comment">-- (including functions, other tables, the table itself, ...)</span>
<span class="identifier">t</span>[<span class="identifier">x</span><span class="symbol">]</span> <span class="symbol">=</span> <span class="identifier">t</span>
</pre>


<p>It’s important to remember that a Lua table has two parts; an array-portion and a hash-table portion. The array portion is indexed with integer keys, starting from 1 upwards. All other keys are stored in the hash (or record) portion.</p>

<p>The array portion gives Lua tables the capability to act as ordered lists, and can grow/shrink as needed (similar to C++ vectors). Sometimes the array portion is called the list portion, because it is useful for creating lists similarly to LISP. In particular, the table constructor will insert numeric keys in order for any values that are not explicitly keyed:</p>

<pre><span class="comment">-- these two lines are equivalent</span>
<span class="keyword">local</span> <span class="identifier">mylist</span> <span class="symbol">=</span> <span class="symbol">{</span> [<span class="number">1</span><span class="symbol">]</span><span class="symbol">=</span><span class="string">"foo"</span>, [<span class="number">2</span><span class="symbol">]</span><span class="symbol">=</span><span class="string">"bar"</span>, [<span class="number">3</span><span class="symbol">]</span><span class="symbol">=</span><span class="string">"baz"</span> <span class="symbol">}</span><span class="symbol">:</span>
<span class="keyword">local</span> <span class="identifier">mylist</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="string">"foo"</span>, <span class="string">"bar"</span>, <span class="string">"baz"</span> <span class="symbol">}</span>

<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">mylist</span>[<span class="number">2</span><span class="symbol">]</span><span class="symbol">)</span>          <span class="comment">--> bar</span>
        
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><a href="http://www.lua.org/manual/5.1/manual.html#pdf-unpack"><span class="global">unpack</span></a><span class="symbol">(</span><span class="identifier">mylist</span><span class="symbol">)</span><span class="symbol">)</span>      <span class="comment">--> foo bar baz </span>
</pre>


<p>Remember that Lua expects most tables to count from 1, not from 0.</p>

<h3>Iterating a table</h3>

<p>To visit <strong>all</strong> key-value pairs of a table, use a for loop like the following. Note that the order of traversal is undefined; it may be different each time.</p>

<pre><span class="keyword">for</span> <span class="identifier">key</span>, <span class="identifier">value</span> <span class="keyword">in</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-pairs"><span class="global">pairs</span></a><span class="symbol">(</span><span class="identifier">mytable</span><span class="symbol">)</span> <span class="keyword">do</span>
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span>
</pre>


<p>To visit <strong>only</strong> array-portion of a table, use one of these forms:</p>

<pre><span class="keyword">for</span> <span class="identifier">i</span> <span class="symbol">=</span> <span class="number">1</span>, <span class="symbol">#</span><span class="identifier">mytable</span> <span class="keyword">do</span>
    <span class="keyword">local</span> <span class="identifier">value</span> <span class="symbol">=</span> <span class="identifier">mytable</span>[<span class="identifier">i</span><span class="symbol">]</span>
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span>

<span class="keyword">for</span> <span class="identifier">key</span>, <span class="identifier">value</span> <span class="keyword">in</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-ipairs"><span class="global">ipairs</span></a><span class="symbol">(</span><span class="identifier">mytable</span><span class="symbol">)</span> <span class="keyword">do</span>
    <span class="comment">-- do things with the key and value</span>
<span class="keyword">end</span>
</pre>


<h3>Functions</h3>

<p>Unlike C, functions are first-class values, just like numbers, strings and tables. That means that functions can take functions as arguments, functions can return other functions as return values, functions can be keys and values in tables. It also means that functions can be created and garbage collected dynamically.</p>

<p>Functions can be declared in several ways:</p>

<pre><span class="comment">-- these are equivalent:</span>
<span class="identifier">sayhello</span> <span class="symbol">=</span> <span class="keyword">function</span><span class="symbol">(</span><span class="identifier">message</span><span class="symbol">)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"hello"</span>, <span class="identifier">message</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="keyword">function</span> <span class="identifier">sayhello</span><span class="symbol">(</span><span class="identifier">message</span><span class="symbol">)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"hello"</span>, <span class="identifier">message</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="comment">-- using the function:</span>
<span class="identifier">sayhello</span><span class="symbol">(</span><span class="string">"me"</span><span class="symbol">)</span>  <span class="comment">-- prints: hello me</span>
<span class="identifier">sayhello</span><span class="symbol">(</span><span class="string">"you"</span><span class="symbol">)</span> <span class="comment">-- prints: hello you</span>

<span class="comment">-- replacing the function</span>
<span class="identifier">sayhello</span> <span class="symbol">=</span> <span class="keyword">function</span><span class="symbol">(</span><span class="identifier">message</span><span class="symbol">)</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"hi"</span>, <span class="identifier">message</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="identifier">sayhello</span><span class="symbol">(</span><span class="string">"me"</span><span class="symbol">)</span>  <span class="comment">-- prints: hi me</span>
</pre>


<p>Functions can zero or more arguments. In Lua, they can also have more than one return vaue:</p>

<pre><span class="keyword">function</span> <span class="identifier">minmax</span><span class="symbol">(</span><span class="identifier">a</span>, <span class="identifier">b</span><span class="symbol">)</span>
  <span class="keyword">return</span> <span class="identifier">math</span><span class="symbol">.</span><span class="identifier">min</span><span class="symbol">(</span><span class="identifier">a</span>, <span class="identifier">b</span><span class="symbol">)</span>, <span class="identifier">math</span><span class="symbol">.</span><span class="identifier">max</span><span class="symbol">(</span><span class="identifier">a</span>, <span class="identifier">b</span><span class="symbol">)</span>
<span class="keyword">end</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">minmax</span><span class="symbol">(</span><span class="number">42</span>, <span class="number">13</span><span class="symbol">)</span><span class="symbol">)</span> <span class="comment">-- prints: 13 42</span>
</pre>


<h3>Logic and control flow</h3>

<pre><span class="comment">-- if blocks:</span>
<span class="keyword">if</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="number">1</span> <span class="keyword">then</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"one"</span><span class="symbol">)</span>
  <span class="comment">-- as many elseifs as desired can be chained</span>
<span class="keyword">elseif</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="number">2</span> <span class="keyword">then</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"two"</span><span class="symbol">)</span>
<span class="keyword">elseif</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="number">3</span> <span class="keyword">then</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"three"</span><span class="symbol">)</span>
<span class="keyword">else</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"many"</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="comment">-- while loops:</span>
<span class="identifier">x</span> <span class="symbol">=</span> <span class="number">10</span>
<span class="keyword">while</span> <span class="identifier">x</span> <span class="symbol">></span> <span class="number">0</span> <span class="keyword">do</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span>
  <span class="identifier">x</span> <span class="symbol">=</span> <span class="identifier">x</span> <span class="symbol">-</span> <span class="number">1</span>
<span class="keyword">end</span>

<span class="keyword">repeat</span>
  <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span>
  <span class="identifier">x</span> <span class="symbol">=</span> <span class="identifier">x</span> <span class="symbol">+</span> <span class="number">1</span>
<span class="keyword">until</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="number">10</span>

<span class="comment">-- numeric for loop:</span>
<span class="comment">-- count from 1 to 10</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="symbol">=</span> <span class="number">1</span>, <span class="number">10</span> <span class="keyword">do</span> 
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">i</span><span class="symbol">)</span> 
<span class="keyword">end</span>        
<span class="comment">-- count 1, 3, 5, 7, 9:</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="symbol">=</span> <span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span> <span class="keyword">do</span> 
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">i</span><span class="symbol">)</span> 
<span class="keyword">end</span>
<span class="comment">-- count down from 10 to 1:</span>
<span class="keyword">for</span> <span class="identifier">i</span> <span class="symbol">=</span> <span class="number">10</span>, <span class="number">1</span>, <span class="symbol">-</span><span class="number">1</span> <span class="keyword">do</span> 
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">i</span><span class="symbol">)</span> 
<span class="keyword">end</span>

<span class="comment">-- logical operators:</span>
<span class="keyword">if</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="identifier">y</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"equal"</span><span class="symbol">)</span> <span class="keyword">end</span>
<span class="keyword">if</span> <span class="identifier">x</span> <span class="symbol">~=</span> <span class="identifier">y</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"not equal"</span><span class="symbol">)</span> <span class="keyword">end</span>
<span class="keyword">if</span> <span class="identifier">x</span> <span class="symbol">></span> <span class="number">0</span> <span class="keyword">and</span> <span class="identifier">x</span> <span class="symbol"><</span> <span class="number">1</span> <span class="keyword">then</span> <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="string">"between 0 and 1"</span><span class="symbol">)</span> <span class="keyword">end</span>
</pre>


<h3>Lexical scoping</h3>

<p>If a variable is declared <code>local</code>, it exists for any code that follows it, until the <code>end</code> of that block. If a variable is not declared local, it becomes a global variable, belonging to the entire script. Use local variables as much as possible, as they are faster, and reduce bugs.</p>

<pre><span class="keyword">function</span> <span class="identifier">foo</span><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span>
  <span class="comment">-- a function body is a new block</span>
  <span class="keyword">local</span> <span class="identifier">y</span> <span class="symbol">=</span> <span class="string">"mylocal"</span>
  <span class="keyword">if</span> <span class="identifier">x</span> <span class="symbol">==</span> <span class="identifier">y</span> <span class="keyword">then</span>
    <span class="comment">-- this is a sub-block of the function</span>
    <span class="comment">-- y is still visible here</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">y</span><span class="symbol">)</span>  <span class="comment">-- prints: mylocal</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="comment">-- y is not visible here:</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">y</span><span class="symbol">)</span>    <span class="comment">-- prints: nil</span>
</pre>


<p>Assigning to a variable that has not been declared locally within the current block will search for that name in parent blocks, recursively, up to the top-level. If the name is found, the assignment is made to that variable. If the name is not found, the assignment becomes a global (either creating a new variable, or replacing an existing global). </p>

<pre><span class="comment">-- an outer variable:</span>
<span class="keyword">local</span> <span class="identifier">x</span> <span class="symbol">=</span> <span class="string">"outside"</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span> <span class="comment">-- prints: outside</span>

<span class="comment">-- sub-block uses a local, which does not affect the outer variable:</span>
<span class="keyword">function</span> <span class="identifier">safe</span><span class="symbol">(</span><span class="symbol">)</span>
  <span class="keyword">local</span> <span class="identifier">x</span> <span class="symbol">=</span> <span class="string">"inside"</span>
<span class="keyword">end</span>
<span class="identifier">safe</span><span class="symbol">(</span><span class="symbol">)</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span> <span class="comment">-- prints: outside</span>

<span class="comment">-- sub-block does not use a local, and overwrites the outer variable:</span>
<span class="keyword">function</span> <span class="identifier">unsafe</span><span class="symbol">(</span><span class="symbol">)</span>
  <span class="identifier">x</span> <span class="symbol">=</span> <span class="string">"inside"</span>
<span class="keyword">end</span>
<span class="identifier">unsafe</span><span class="symbol">(</span><span class="symbol">)</span>
<a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">x</span><span class="symbol">)</span> <span class="comment">-- prints: inside</span>
</pre>


<h3>Method syntax</h3>

<p>Objects in Lua that have functions as members can invoke these functions using a special colon syntax:</p>

<pre><span class="comment">-- create an object:</span>
<span class="identifier">myobject</span> <span class="symbol">=</span> <span class="symbol">{</span> <span class="identifier">value</span> <span class="symbol">=</span> <span class="number">10</span> <span class="symbol">}</span>

<span class="comment">-- add a function:</span>
<span class="identifier">myobject</span><span class="symbol">.</span><span class="identifier">printvalue</span> <span class="symbol">=</span> <span class="keyword">function</span><span class="symbol">(</span><span class="identifier">self</span><span class="symbol">)</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">self</span><span class="symbol">.</span><span class="identifier">value</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="comment">-- test it:</span>
<span class="identifier">myobject</span><span class="symbol">.</span><span class="identifier">printvalue</span><span class="symbol">(</span><span class="identifier">myobject</span><span class="symbol">)</span>   <span class="comment">--> 10</span>

<span class="comment">-- use the colon syntax instead passes the 'self' argument implicitly:</span>
<span class="keyword">function</span> <span class="identifier">myobject</span><span class="symbol">:</span><span class="identifier">printvalue</span><span class="symbol">(</span><span class="symbol">)</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">self</span><span class="symbol">.</span><span class="identifier">value</span><span class="symbol">)</span>
<span class="keyword">end</span>

<span class="identifier">myobject</span><span class="symbol">:</span><span class="identifier">printvalue</span><span class="symbol">(</span><span class="symbol">)</span>           <span class="comment">--> 10</span>
</pre>


<h3>Closures</h3>

<p>Closures arise from the mixed use of lexically scoped local variables, and higher order functions. Any function that makes use of non-local variables effectively keeps those variable references alive within it. An example explains this better:</p>

<pre><span class="keyword">function</span> <span class="identifier">make_counter</span><span class="symbol">(</span><span class="symbol">)</span>
  <span class="keyword">local</span> <span class="identifier">count</span> <span class="symbol">=</span> <span class="number">0</span>
  <span class="keyword">return</span> <span class="keyword">function</span><span class="symbol">(</span><span class="symbol">)</span>
    <span class="identifier">count</span> <span class="symbol">=</span> <span class="identifier">count</span> <span class="symbol">+</span> <span class="number">1</span>
    <a href="http://www.lua.org/manual/5.1/manual.html#pdf-print"><span class="global">print</span></a><span class="symbol">(</span><span class="identifier">count</span><span class="symbol">)</span>
  <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">-- call to make_counter() returns a function;</span>
<span class="comment">-- and 'captures' the local count as an 'upvalue' specific to it</span>
<span class="keyword">local</span> <span class="identifier">c1</span> <span class="symbol">=</span> <span class="identifier">make_counter</span><span class="symbol">(</span><span class="symbol">)</span>
<span class="identifier">c1</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 1</span>
<span class="identifier">c1</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 2</span>
<span class="identifier">c1</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 3</span>

<span class="comment">-- another call to make_counter() creates a new function,</span>
<span class="comment">-- with a new count upvalue</span>
<span class="keyword">local</span> <span class="identifier">c2</span> <span class="symbol">=</span> <span class="identifier">make_counter</span><span class="symbol">(</span><span class="symbol">)</span>
<span class="identifier">c2</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 1</span>
<span class="identifier">c2</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 2</span>

<span class="comment">-- the two function's upvalues are independent of each other:</span>
<span class="identifier">c1</span><span class="symbol">(</span><span class="symbol">)</span>  <span class="comment">-- prints: 4</span>
</pre>


<h2>Modules</h2>

<p>A module is (usually) just a table of functions, stored in a separate file. Modules act like external libraries: re-usable, encapsulated, <em>modular</em>. Load modules using <em>require</em>:</p>

<p><code>`
-- load the foo module (foo.lua):
local foo = require "foo"</code></p>

<p>&mdash; use a module function:
foo.this()
foo.that()
<code>`</code></p>

<p>To create a module, simply create a Lua script whose last action is to return a table. This table will typically have functions inside. Modules should not create any global variables, only locals. Modules can be placed next to the script, or in any of the locations specified by the <em>package.path</em> string. The name of the module file should match the module name.</p>

<p><code>`
-- this is the foo module, i.e. foo.lua</code></p>

<p>&mdash; create the module table
local foo = {}</p>

<p>&mdash; add some functions to the module:
foo.this = function()</p>

<pre><code>print('this')
</code></pre>

<p>end
foo.that = function()</p>

<pre><code>print('that')
</code></pre>

<p>end</p>

<p>&mdash; return the module table
return foo
<code>`</code></p>

<p>Lua guarantees a given module is only executed once. Additional calls to <em>require &ldquo;foo&rdquo;</em> will always return the same table.</p>

<h2>LuaJIT FFI</h2>

<p>The <a href="http://luajit.org/ext_ffi.html">Foreign-Function Interface (FFI)</a> allows LuaJIT to work with C language data types and functions, and even load and use pre-compiled C libraries. Working with FFI types is usually more difficult (and dangerous!) than plain Lua, but in certain cases it can run a lot faster. To use the ffi, first:</p>

<p><code>`
local ffi = require "ffi"
</code><code></code></p>

<p>To create a new C-type object (&ldquo;cdata&rdquo;), use <strong>ffi.new()</strong>. For example, to create C-style arrays of 64-bit floating point numbers (C-type <em>double</em>):</p>

<p><code>`
-- create an array of five numbers (initialized with zeroes by default):
local arr = ffi.new("double[5]")
local arr = ffi.new("double[?]", 5)</code></p>

<p>&mdash; create an array of five numbers (initialized with 1, 2, 3, 4, 5):
local arr = ffi.new(&ldquo;double[5]&rdquo;, 1, 2, 3, 4, 5)
local arr = ffi.new(&ldquo;double[?]&rdquo;, 5, 1, 2, 3, 4, 5)
local arr = ffi.new(&ldquo;double[5]&rdquo;, {1, 2, 3, 4, 5})
local arr = ffi.new(&ldquo;double[?]&rdquo;, 5, {1, 2, 3, 4, 5})
<code>`</code></p>

<p>Arrays can be indexed just as in C. That means <em>it counts from zero</em>, unlike Lua tables that count from 1:</p>

<p><code>`
arr[2] = 4.2
print(arr[2])   --&gt; prints 4.2
</code><code></code></p>

<p>The <strong>ffi.cdef</strong> function is used to define new aggregate C types (structs):</p>

<p><code>`
-- create declarations of C types in a long string:
local cdefs = [[</code></p>

<pre><code>typedef struct {
    int a;
    double b;
} foo;

typedef struct {
    foo first;
    foo second;
} foopair;
</code></pre>

<p>]]
&mdash; add these types the the FFI:
ffi.cdef(cdefs)</p>

<p>&mdash; create a new &ldquo;foo&rdquo; type with all members set to zero:
local myfoo = ffi.new(&ldquo;foo&rdquo;)</p>

<p>&mdash; create a new &ldquo;foo&rdquo; type with specific values:
local myfoo = ffi.new(&ldquo;foo&rdquo;, { 100, 4.2 })</p>

<p>print(myfoo.a)       &mdash;> prints 100
print(myfoo.b)      &mdash;> prints 4.2</p>

<p>&mdash; create a new &ldquo;foopair&rdquo;:
local myfoopair = ffi.new(&ldquo;foopair&rdquo;, { { 100, 4.2 }, { 200, 3.14 } })</p>

<p>print(myfoo.second.a)   &mdash;> prints 200
<code>`</code></p>

<p>The <strong>ffi.load</strong> function is used to load a precompiled library of C code. It is usually coupled with a <strong>ffi.cdef</strong> to declare the functions and types the library contains:</p>

<p><code>`
-- load the "libsndfile" dynamic library:
local lib = ffi.load("libsndfile-1.dll")</code></p>

<p>&mdash; declare one of the functions exported by the library
&mdash; (usually we would declare them all at once, but here we just declare one for the example)
ffi.cdef [[</p>

<pre><code>const char * sf_version_string();
</code></pre>

<p>]]</p>

<p>&mdash; use this function by indexing the library:
local version = lib.sf_version_string()</p>

<p>&mdash; version is a cdata of type &ldquo;const char *&rdquo;
&mdash; (i.e. an immutable array of bytes)
&mdash; we can turn it into a Lua string using ffi.string:
print(ffi.string(version))
<code>`</code></p>

<p>Note that the special symbol <strong>ffi.C</strong> is a namespace for all the symbols exported by the application itself, including the basic C math library.</p>

<p>We can get the type of a cdata with <strong>ffi.typeof</strong>, check it with <strong>ffi.istype</strong>, get the size of a type with <strong>ffi.sizeof</strong> and <strong>ffi.offsetof</strong>, cast cdata between types (e.g. pointer casts) using <strong>ffi.cast</strong>, copy or set memory (akin to memcpy and memset) with <strong>ffi.copy</strong> and <strong>ffi.fill</strong>, all basically following the usual rules in C. We can get platform information using <strong>ffi.os</strong>, <strong>ffi.arch</strong> and <strong>ffi.abi</strong>. We can attach special behavior to a cdata <em>type</em> using <strong>ffi.metatype</strong>, similar to metatables for Lua types. We can add a callback to a cdata <em>object</em> when it is garbage collected using <strong>ffi.gc</strong>. <a href="http://luajit.org/ext_ffi_api.html">See the FFI API here</a></p>

<p>With these features, we can interoperate with most C libraries directly from within Lua, without unduly compromising efficiency.</p>

<h2>Help</h2>

<p><a href="http://www.lua.org/manual/5.1">Reference manual</a>; bookmark the <a href="http://www.lua.org/manual/5.1/index.html#index">contents</a>.</p>

<p><em>Excellent</em> text-book: <a href="http://www.lua.org/docs.html#books">Programming in Lua (second edition)</a>
<img src="http://www.lua.org/images/pil2.jpg" alt="PIL" /></p>

<!-- main@ --></div>



<footer>
&copy; 2008-2014 Graham Wakefield &amp; Wesley Smith. 
</footer>

</body>
</html>